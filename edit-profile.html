<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Profile | TailorLink</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <style>
      /* --- Root Variables & Base Styles --- */
      :root {
        --primary-color: #0a192f;
        --primary-dark: #0f6e16;
        --background-color: #f0f2f5;
        --card-background: #ffffff;
        --text-color: #333;
        --text-muted: #666;
        --input-border-color: #e0e0e0;
        --focus-border-color: var(--primary-color);
        --error-color: #e74c3c;
        --success-color: #27ae60;
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.1);
        --border-radius-soft: 8px;
        --border-radius-round: 50%;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      /* --- Navigation Bar --- */
      .navbar {
        width: 100%;
        max-width: 800px;
        background-color: var(--card-background);
        box-shadow: var(--shadow-light);
        border-radius: var(--border-radius-soft);
        padding: 15px 25px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar .logo {
        font-family: "Poppins", sans-serif;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--primary-color);
        text-decoration: none;
      }

      .navbar .nav-links a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        padding: 8px 15px;
        border-radius: var(--border-radius-soft);
        transition: background-color 0.2s ease;
      }

      .navbar .nav-links a:hover {
        background-color: rgba(23, 145, 29, 0.1);
      }

      /* --- Wrapper / Form Container --- */
      .wrapper {
        width: 100%;
        max-width: 800px;
        background-color: var(--card-background);
        box-shadow: var(--shadow-medium);
        border-radius: var(--border-radius-soft);
        padding: 40px;
        text-align: center;
      }

      h1 {
        font-family: "Poppins", sans-serif;
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1rem;
        color: var(--text-muted);
        margin-bottom: 2rem;
      }

      /* --- Profile Image Section --- */
      .profile-image-section {
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .profile-image-container {
        width: 120px;
        height: 120px;
        border-radius: var(--border-radius-round);
        overflow: hidden;
        border: 3px solid var(--primary-color);
        box-shadow: var(--shadow-light);
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
        position: relative;
      }

      .profile-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .image-upload-label {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: var(--border-radius-soft);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.2s ease;
        border: none;
      }

      .image-upload-label:hover {
        background-color: var(--primary-dark);
      }

      .image-upload-label:disabled {
        background-color: #a0a0a0;
        cursor: not-allowed;
      }

      #fileInput {
        display: none;
      }

      .upload-status {
        font-size: 0.8rem;
        margin-top: 5px;
        min-height: 20px;
      }

      .upload-status.success {
        color: var(--success-color);
      }

      .upload-status.error {
        color: var(--error-color);
      }

      /* --- Form Styling --- */
      form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        align-items: stretch;
      }

      @media (min-width: 600px) {
        form {
          grid-template-columns: 1fr 1fr;
          gap: 1.5rem;
        }
        .full-width {
          grid-column: 1 / -1;
        }
      }

      .input-group {
        width: 100%;
        position: relative;
        text-align: left;
      }

      .input-group label {
        display: block;
        font-size: 0.9rem;
        color: var(--text-color);
        margin-bottom: 5px;
        font-weight: 500;
      }

      input,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--input-border-color);
        border-radius: var(--border-radius-soft);
        font-size: 1rem;
        font-family: "Inter", sans-serif;
        color: var(--text-color);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        outline: none;
        background-color: var(--card-background);
      }

      textarea {
        min-height: 80px;
        resize: vertical;
      }

      input:focus,
      textarea:focus {
        border-color: var(--focus-border-color);
        box-shadow: 0 0 0 3px rgba(23, 145, 29, 0.2);
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
        opacity: 0.8;
      }

      .password-toggle {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(20%);
        cursor: pointer;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .input-group.incorrect .password-toggle {
        color: var(--error-color);
      }

      /* --- Button Styles --- */
      .btn-submit {
        width: 100%;
        padding: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-soft);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease,
          transform 0.3s ease;
        margin-top: 1rem;
        grid-column: 1 / -1;
      }

      .btn-submit:hover:not(:disabled) {
        background-color: var(--primary-dark);
        box-shadow: 0 6px 15px rgba(23, 145, 29, 0.35);
        transform: translateY(-2px);
      }

      .btn-submit:disabled {
        background-color: #a0a0a0;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .back-button {
        text-decoration: none;
        color: #ffffff;
        background-color: #0f6e16;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        margin-bottom: 1rem;
        display: inline-block;
        transition: background-color 0.3s ease;
      }

      .back-button:hover {
        background-color: var(--primary-dark);
      }

      /* --- Error Message --- */
      #error-message {
        color: var(--error-color);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: left;
        width: 100%;
        grid-column: 1 / -1;
        min-height: 20px;
      }

      #error-message.success {
        color: var(--success-color);
      }

      /* --- Input Validation Styling --- */
      .input-group.incorrect input,
      .input-group.incorrect textarea {
        border-color: var(--error-color);
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
      }

      /* --- Loader Overlay --- */
      .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: none;
      }

      .loader {
        border: 6px solid #f3f3f3;
        border-top: 6px solid var(--primary-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Progress Bar --- */
      .progress-container {
        width: 100%;
        height: 4px;
        background-color: #f0f0f0;
        border-radius: 2px;
        margin-top: 10px;
        overflow: hidden;
        display: none;
      }

      .progress-bar {
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 2px;
        transition: width 0.3s ease;
        width: 0%;
      }

      /* --- Responsive Adjustments --- */
      @media (max-width: 600px) {
        body {
          padding: 15px;
        }
        .navbar {
          padding: 10px 15px;
        }
        .navbar .logo {
          font-size: 1.2rem;
        }
        .navbar .nav-links a {
          padding: 6px 10px;
          font-size: 0.9rem;
        }
        .wrapper {
          padding: 25px;
        }
        h1 {
          font-size: 1.8rem;
        }
        .subtitle {
          font-size: 0.9rem;
          margin-bottom: 1.5rem;
        }
        .profile-image-container {
          width: 100px;
          height: 100px;
        }
        .image-upload-label {
          padding: 8px 15px;
          font-size: 0.8rem;
        }
        .input-group label {
          font-size: 0.85rem;
        }
        input,
        textarea {
          padding: 10px 12px;
          font-size: 0.9rem;
        }
        .btn-submit {
          font-size: 1rem;
          padding: 10px;
        }
        .back-button {
          padding: 0.4rem 0.8rem;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="loader-overlay" class="loader-overlay">
      <div class="loader"></div>
    </div>

    <nav class="navbar">
      <a href="javascript:void(0);" class="logo" id="dashboard-link">TailorLinkðŸ”—</a>
      <div class="nav-links">
        <a href="javascript:void(0);" id="logout-btn">Logout</a>
      </div>
    </nav>

    <div class="wrapper">
      <a href="dashboard-tailors.html" class="back-button">ðŸ”™ Back to Dashboard</a>
      
      <h1>Edit Your Profile</h1>
      <p class="subtitle">Update your personal and professional information</p>
      <p id="error-message"></p>

      <form id="editProfileForm">
        <div class="profile-image-section full-width">
          <div class="profile-image-container">
            <img id="preview" src="" alt="Profile Image" />
          </div>
          <button type="button" class="image-upload-label" id="uploadButton">
            Upload Photo
          </button>
          <input type="file" id="fileInput" accept="image/*" />
          <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <p class="upload-status" id="uploadStatus"></p>
        </div>

        <div class="input-group">
          <label for="fullName">Full Name</label>
          <input
            type="text"
            id="fullName"
            placeholder="Your Full Name"
            required
            autocomplete="name"
          />
        </div>
        
        <div class="input-group">
          <label for="email">Email Address</label>
          <input
            type="email"
            id="email"
            placeholder="Your Email Address"
            required
            autocomplete="email"
            disabled
          />
        </div>
        
        <div class="input-group">
          <label for="phone">Phone Number</label>
          <input
            type="tel"
            id="phone"
            placeholder="e.g., +2348012345678"
            autocomplete="tel"
          />
        </div>
        
        <div class="input-group">
          <label for="location">Location</label>
          <input
            type="text"
            id="location"
            placeholder="City, State / Country"
            autocomplete="address-level2"
          />
        </div>

        <div class="input-group full-width">
          <label for="currentPassword">Current Password (for changes)</label>
          <input
            type="password"
            id="currentPassword"
            placeholder="Enter current password if changing"
            autocomplete="current-password"
          />
          <span class="password-toggle" id="toggleCurrentPassword">
            <i class="fa fa-eye-slash" aria-hidden="true"></i>
          </span>
        </div>
        
        <div class="input-group">
          <label for="newPassword">New Password</label>
          <input
            type="password"
            id="newPassword"
            placeholder="Leave blank if not changing"
            minlength="6"
            autocomplete="new-password"
          />
          <span class="password-toggle" id="toggleNewPassword">
            <i class="fa fa-eye-slash" aria-hidden="true"></i>
          </span>
        </div>
        
        <div class="input-group">
          <label for="confirmNewPassword">Confirm New Password</label>
          <input
            type="password"
            id="confirmNewPassword"
            placeholder="Confirm new password"
            minlength="6"
            autocomplete="new-password"
          />
          <span class="password-toggle" id="toggleConfirmNewPassword">
            <i class="fa fa-eye-slash" aria-hidden="true"></i>
          </span>
        </div>

        <div id="tailorSpecificFields" class="full-width" style="display: none">
          <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0" />
          <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem">Tailor Information</h2>
          
          <div class="input-group">
            <label for="bio">Biography / Description</label>
            <textarea
              id="bio"
              placeholder="Tell clients about yourself and your tailoring style (max 500 characters)"
              maxlength="500"
            ></textarea>
          </div>
          
          <div class="input-group">
            <label for="experience">Years of Experience</label>
            <input
              type="text"
              id="experience"
              placeholder="e.g., 5 years, 10+ years. Note: Honest is the best policy ðŸ˜‰"
            />
          </div>
          
          <div class="input-group">
            <label for="services">Services Offered (Comma Separated)</label>
            <input
              type="text"
              id="services"
              placeholder="e.g., Suits, Dresses, Alterations, Embroidery"
            />
          </div>
          
          <div class="input-group">
            <label for="price">Pricing Model</label>
            <input
              type="text"
              id="price"
              placeholder="e.g., NGN 5,000+, Price on request"
            />
          </div>
        </div>

        <button type="submit" class="btn-submit">Save Changes</button>
      </form>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBVjsT4eVkdZaWaYfkgz_hoK00ZgmLWNR4",
        authDomain: "tailorlink-571d5.firebaseapp.com",
        projectId: "tailorlink-571d5",
        storageBucket: "tailorlink-571d5.appspot.com",
        messagingSenderId: "685008238153",
        appId: "1:685008238153:web:8625d73d9511fde3f2b198",
        measurementId: "G-H9RNR0LLKF",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();

      // DOM Elements
      const loaderOverlay = document.getElementById("loader-overlay");
      const dashboardLink = document.getElementById("dashboard-link");
      const logoutBtn = document.getElementById("logout-btn");
      const editProfileForm = document.getElementById("editProfileForm");
      const profileImgPreview = document.getElementById("preview");
      const fileInput = document.getElementById("fileInput");
      const uploadButton = document.getElementById("uploadButton");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const uploadStatus = document.getElementById("uploadStatus");
      const fullNameInput = document.getElementById("fullName");
      const emailInput = document.getElementById("email");
      const phoneInput = document.getElementById("phone");
      const locationInput = document.getElementById("location");
      const currentPasswordInput = document.getElementById("currentPassword");
      const newPasswordInput = document.getElementById("newPassword");
      const confirmNewPasswordInput = document.getElementById("confirmNewPassword");
      const tailorSpecificFields = document.getElementById("tailorSpecificFields");
      const bioInput = document.getElementById("bio");
      const experienceInput = document.getElementById("experience");
      const servicesInput = document.getElementById("services");
      const priceInput = document.getElementById("price");
      const errorMessageDisplay = document.getElementById("error-message");
      const submitButton = document.querySelector(".btn-submit");

      // Password Toggle Elements
      const toggleCurrentPassword = document.getElementById("toggleCurrentPassword");
      const toggleNewPassword = document.getElementById("toggleNewPassword");
      const toggleConfirmNewPassword = document.getElementById("toggleConfirmNewPassword");

      let currentUser = null;
      let userRole = null;

      const defaultProfileImageUrl = "data:image/jpeg;base64,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";

      // Helper Functions
      function showLoader() {
        loaderOverlay.style.display = "flex";
      }

      function hideLoader() {
        loaderOverlay.style.display = "none";
      }

      function markInputIncorrect(inputElement) {
        if (inputElement) {
          inputElement.closest(".input-group").classList.add("incorrect");
        }
      }

      function clearInputError(inputElement) {
        if (inputElement) {
          inputElement.closest(".input-group").classList.remove("incorrect");
        }
      }

      function clearAllInputErrors() {
        document.querySelectorAll(".input-group.incorrect").forEach((group) => {
          group.classList.remove("incorrect");
        });
      }

      function displayErrorMessage(message, isSuccess = false) {
        errorMessageDisplay.textContent = message;
        if (isSuccess) {
          errorMessageDisplay.classList.add("success");
        } else {
          errorMessageDisplay.classList.remove("success");
        }
      }

      function setUploadStatus(message, type = 'info') {
        uploadStatus.textContent = message;
        uploadStatus.className = `upload-status ${type}`;
      }

      // Password Toggle Logic
      function setupPasswordToggle(toggleBtn, inputField) {
        toggleBtn.addEventListener("click", function () {
          const type = inputField.getAttribute("type") === "password" ? "text" : "password";
          inputField.setAttribute("type", type);
          this.querySelector("i").classList.toggle("fa-eye");
          this.querySelector("i").classList.toggle("fa-eye-slash");
        });
      }

      setupPasswordToggle(toggleCurrentPassword, currentPasswordInput);
      setupPasswordToggle(toggleNewPassword, newPasswordInput);
      setupPasswordToggle(toggleConfirmNewPassword, confirmNewPasswordInput);

      // Test Firebase Storage Connection
      async function testStorageConnection() {
        try {
          console.log("Testing Firebase Storage connection...");
          const testRef = storage.ref().child('test/connection.txt');
          const testData = 'test connection';
          await testRef.putString(testData);
          await testRef.delete(); // Clean up
          console.log("âœ… Firebase Storage connection successful");
          return true;
        } catch (error) {
          console.error("âŒ Firebase Storage connection failed:", error);
          return false;
        }
      }

      // Image Upload Functionality
      uploadButton.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        console.log("ðŸ” Upload Debug Info:");
        console.log("File selected:", file.name);
        console.log("File size:", (file.size / 1024 / 1024).toFixed(2) + " MB");
        console.log("File type:", file.type);
        console.log("User authenticated:", !!currentUser);
        console.log("User ID:", currentUser?.uid);
        console.log("Storage bucket:", firebaseConfig.storageBucket);

        if (!currentUser) {
          setUploadStatus("Please log in to upload an image.", 'error');
          return;
        }

        // Test storage connection first
        const storageWorking = await testStorageConnection();
        if (!storageWorking) {
          setUploadStatus("Storage connection failed. Check console for details.", 'error');
          return;
        }

        // Validate file type
        const allowedTypes = ["image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"];
        if (!allowedTypes.includes(file.type)) {
          setUploadStatus("Only JPEG, PNG, GIF, and WebP images are allowed.", 'error');
          console.log("âŒ File type rejected:", file.type);
          return;
        }

        // Validate file size (max 5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          setUploadStatus("Image file size must be less than 5MB.", 'error');
          console.log("âŒ File too large:", (file.size / 1024 / 1024).toFixed(2) + " MB");
          return;
        }

        // Check if file is actually readable
        try {
          const arrayBuffer = await file.arrayBuffer();
          if (arrayBuffer.byteLength === 0) {
            setUploadStatus("File appears to be empty or corrupted.", 'error');
            return;
          }
          console.log("âœ… File is readable, size:", arrayBuffer.byteLength);
        } catch (error) {
          console.error("âŒ Cannot read file:", error);
          setUploadStatus("Cannot read file. Please try a different image.", 'error');
          return;
        }

        uploadButton.disabled = true;
        uploadButton.textContent = "Uploading...";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        setUploadStatus("Preparing upload...", 'info');

        let uploadTimeout;
        let isUploadComplete = false;
        let progressStalled = false;
        let lastProgress = 0;
        let progressCheckInterval;

        try {
          const timestamp = Date.now();
          const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
          const fileName = `${timestamp}_${sanitizedFileName}`;
          const imagePath = `profile_images/${currentUser.uid}/${fileName}`;
          
          console.log("ðŸ“ Upload path:", imagePath);

          const storageRef = storage.ref();
          const imageRef = storageRef.child(imagePath);
          
          console.log("ðŸš€ Starting upload...");
          setUploadStatus("Starting upload...", 'info');

          // Create upload task
          const uploadTask = imageRef.put(file, {
            contentType: file.type,
            cacheControl: 'public,max-age=3600'
          });

          // Progress stall detection
          progressCheckInterval = setInterval(() => {
            if (!isUploadComplete && lastProgress === 0) {
              progressStalled = true;
              console.warn("âš ï¸ Upload appears stalled at 0%");
            }
          }, 5000); // Check every 5 seconds

          // Main upload timeout (2 minutes)
          uploadTimeout = setTimeout(() => {
            if (!isUploadComplete) {
              console.warn("â° Upload timeout reached (120s)");
              uploadTask.cancel();
              setUploadStatus("Upload timeout. Please try again with a smaller image.", 'error');
              resetUploadUI();
            }
          }, 120000);

          uploadTask.on(
            "state_changed",
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              const progressRounded = Math.round(progress * 100) / 100; // 2 decimal places
              
              console.log(`ðŸ“Š Upload progress: ${progressRounded}% (${snapshot.bytesTransferred}/${snapshot.totalBytes} bytes)`);
              console.log("Upload state:", snapshot.state);
              
              progressBar.style.width = progress + "%";
              setUploadStatus(`Uploading: ${Math.round(progress)}%`, 'info');
              
              lastProgress = progress;
              
              // Reset stall detection on progress
              if (progress > 0) {
                progressStalled = false;
                if (progressCheckInterval) {
                  clearInterval(progressCheckInterval);
                  progressCheckInterval = null;
                }
              }

              // Log detailed state information
              switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED:
                  console.log("Upload is paused");
                  break;
                case firebase.storage.TaskState.RUNNING:
                  console.log("Upload is running");
                  break;
              }
            },
            (error) => {
              isUploadComplete = true;
              if (uploadTimeout) clearTimeout(uploadTimeout);
              if (progressCheckInterval) clearInterval(progressCheckInterval);
              
              console.error("ðŸ’¥ Upload error details:");
              console.error("Error code:", error.code);
              console.error("Error message:", error.message);
              console.error("Full error:", error);
              
              let errorMessage = "Upload failed: ";
              switch (error.code) {
                case 'storage/unauthorized':
                  errorMessage += "Permission denied. Please refresh and try again.";
                  console.log("Auth token:", currentUser?.accessToken ? "Present" : "Missing");
                  break;
                case 'storage/canceled':
                  errorMessage += "Upload was cancelled.";
                  break;
                case 'storage/unknown':
                  errorMessage += "Unknown error. Check your internet connection.";
                  break;
                case 'storage/retry-limit-exceeded':
                  errorMessage += "Connection timeout. Please try again.";
                  break;
                case 'storage/invalid-checksum':
                  errorMessage += "File corrupted during upload. Please try again.";
                  break;
                case 'storage/quota-exceeded':
                  errorMessage += "Storage quota exceeded.";
                  break;
                default:
                  errorMessage += `${error.message}`;
              }
              
              setUploadStatus(errorMessage, 'error');
              resetUploadUI();
            },
            async () => {
              isUploadComplete = true;
              if (uploadTimeout) clearTimeout(uploadTimeout);
              if (progressCheckInterval) clearInterval(progressCheckInterval);
              
              try {
                console.log("âœ… Upload completed successfully!");
                setUploadStatus("Upload complete, getting URL...", 'info');
                
                const downloadURL = await imageRef.getDownloadURL();
                console.log("ðŸ”— Download URL obtained:", downloadURL);
                
                // Test if URL is accessible
                try {
                  const response = await fetch(downloadURL, { method: 'HEAD' });
                  console.log("ðŸŒ URL accessibility test:", response.status);
                } catch (urlTest) {
                  console.warn("âš ï¸ URL test failed (might still work):", urlTest);
                }
                
                profileImgPreview.src = downloadURL;
                setUploadStatus("Updating profile in database...", 'info');

                // Update Firestore with new image URL
                console.log("ðŸ’¾ Updating user document...");
                await db.collection("users").doc(currentUser.uid).update({
                  profileImage: downloadURL,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (userRole === "tailor") {
                  console.log("ðŸ‘” Updating tailor document...");
                  await db.collection("tailors").doc(currentUser.uid).update({
                    profileImage: downloadURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }

                console.log("âœ… Profile image updated successfully!");
                setUploadStatus("Profile image updated successfully! ðŸŽ‰", 'success');
                
                setTimeout(() => {
                  progressContainer.style.display = "none";
                  uploadButton.disabled = false;
                  uploadButton.textContent = "Upload Photo";
                  fileInput.value = '';
                  setUploadStatus("", 'info');
                }, 3000);
                
              } catch (dbError) {
                console.error("ðŸ’¾ Database update error:", dbError);
                setUploadStatus("Image uploaded but failed to update profile. Please refresh the page.", 'error');
                resetUploadUI();
              }
            }
          );

          console.log("ðŸ“¤ Upload task created and started");

        } catch (error) {
          isUploadComplete = true;
          if (uploadTimeout) clearTimeout(uploadTimeout);
          if (progressCheckInterval) clearInterval(progressCheckInterval);
          
          console.error("ðŸš« Error creating upload:", error);
          setUploadStatus("Failed to start upload: " + error.message, 'error');
          resetUploadUI();
        }

        function resetUploadUI() {
          progressContainer.style.display = "none";
          progressBar.style.width = "0%";
          uploadButton.disabled = false;
          uploadButton.textContent = "Upload Photo";
          fileInput.value = '';
          if (progressCheckInterval) {
            clearInterval(progressCheckInterval);
            progressCheckInterval = null;
          }
        }
      });

      // Populate Form with User Data
      async function populateProfileData(user) {
        showLoader();
        try {
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (!userDoc.exists) {
            console.error("User document not found in Firestore.");
            throw new Error("User profile not found. Please log in again.");
          }

          const userData = userDoc.data();
          currentUser = user;
          userRole = userData.role;

          fullNameInput.value = userData.fullName || "";
          emailInput.value = userData.email || "";
          phoneInput.value = userData.phone || "";
          locationInput.value = userData.location || "";

          // Set profile image
          if (userData.profileImage) {
            profileImgPreview.src = userData.profileImage;
          } else {
            profileImgPreview.src = defaultProfileImageUrl;
          }

          // Show tailor-specific fields if role is 'tailor'
          if (userRole === "tailor") {
            tailorSpecificFields.style.display = "block";
            const tailorDoc = await db.collection("tailors").doc(user.uid).get();
            if (tailorDoc.exists) {
              const tailorData = tailorDoc.data();
              bioInput.value = tailorData.bio || "";
              experienceInput.value = tailorData.experience || "";
              servicesInput.value = (tailorData.services || []).join(", ");
              priceInput.value = tailorData.price || "";
            }
          } else {
            tailorSpecificFields.style.display = "none";
          }

          // Adjust dashboard link based on role
          if (userRole === "customer") {
            dashboardLink.href = "explore.html";
          } else if (userRole === "tailor") {
            dashboardLink.href = "dashboard-tailors.html";
          } else if (userRole === "admin") {
            dashboardLink.href = "dashboard-admin.html";
          } else {
            dashboardLink.href = "#";
          }
        } catch (error) {
          console.error("Error populating profile data:", error);
          displayErrorMessage("Failed to load profile data. Please refresh or log in again.");
          setTimeout(() => {
            auth.signOut();
            window.location.href = "login.html";
          }, 3000);
        } finally {
          hideLoader();
        }
      }

      // Handle Form Submission
      editProfileForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        showLoader();
        submitButton.textContent = "Saving...";
        submitButton.disabled = true;
        displayErrorMessage("");
        clearAllInputErrors();

        const fullName = fullNameInput.value.trim();
        const phone = phoneInput.value.trim();
        const location = locationInput.value.trim();
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmNewPassword = confirmNewPasswordInput.value;

        // Validation
        const errors = [];

        if (!fullName) {
          errors.push("Full Name is required.");
          markInputIncorrect(fullNameInput);
        }

        if (newPassword && newPassword.length < 6) {
          errors.push("New password must be at least 6 characters long.");
          markInputIncorrect(newPasswordInput);
        }

        if (newPassword && newPassword !== confirmNewPassword) {
          errors.push("New passwords do not match.");
          markInputIncorrect(newPasswordInput);
          markInputIncorrect(confirmNewPasswordInput);
        }

        if (newPassword && !currentPassword) {
          errors.push("Current password is required to change password.");
          markInputIncorrect(currentPasswordInput);
        }

        // Tailor-specific validation
        let bio = "";
        let experience = "";
        let services = [];
        let price = "";

        if (userRole === "tailor") {
          bio = bioInput.value.trim();
          experience = experienceInput.value.trim();
          price = priceInput.value.trim();

          const servicesRaw = servicesInput.value.trim();
          if (!servicesRaw) {
            errors.push("Services Offered are required for tailors.");
            markInputIncorrect(servicesInput);
          } else {
            services = servicesRaw
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s !== "");
            if (services.length === 0) {
              errors.push("Please enter at least one service offered.");
              markInputIncorrect(servicesInput);
            }
          }
        }

        if (errors.length > 0) {
          displayErrorMessage(errors.join(" "));
          hideLoader();
          submitButton.textContent = "Save Changes";
          submitButton.disabled = false;
          return;
        }

        try {
          // Update Firebase Authentication Profile
          if (currentUser) {
            if (currentUser.displayName !== fullName) {
              await currentUser.updateProfile({ displayName: fullName });
            }

            // Update password if provided
            if (newPassword) {
              const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email,
                currentPassword
              );
              await currentUser.reauthenticateWithCredential(credential);
              await currentUser.updatePassword(newPassword);
              
              // Clear password fields
              currentPasswordInput.value = "";
              newPasswordInput.value = "";
              confirmNewPasswordInput.value = "";
              
              // Reset password toggle icons
              document.querySelectorAll('.password-toggle i').forEach(icon => {
                icon.className = "fa fa-eye-slash";
              });
              document.querySelectorAll('input[type="text"][id*="Password"]').forEach(input => {
                input.setAttribute("type", "password");
              });
            }
          }

          // Update Firestore User Data
          const userUpdateData = {
            fullName: fullName,
            phone: phone || null,
            location: location || null,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db.collection("users").doc(currentUser.uid).update(userUpdateData);

          // Update Firestore Tailor Data (if applicable)
          if (userRole === "tailor") {
            const tailorUpdateData = {
              name: fullName,
              phone: phone || null,
              location: location || null,
              bio: bio || null,
              experience: experience || null,
              services: services,
              price: price || null,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            await db.collection("tailors").doc(currentUser.uid).update(tailorUpdateData);
          }

          displayErrorMessage("Profile updated successfully!", true);
          
          // Auto-hide success message after 3 seconds
          setTimeout(() => {
            displayErrorMessage("");
          }, 3000);
          
        } catch (error) {
          console.error("Error saving profile:", error);
          let userFacingMessage = "Failed to save profile. Please try again.";

          if (error.code === "auth/requires-recent-login") {
            userFacingMessage = "Please log out and log in again to update your password.";
            markInputIncorrect(currentPasswordInput);
          } else if (error.code === "auth/wrong-password") {
            userFacingMessage = "Incorrect current password.";
            markInputIncorrect(currentPasswordInput);
          } else if (error.code === "auth/weak-password") {
            userFacingMessage = "The new password is too weak. Please choose a stronger one.";
            markInputIncorrect(newPasswordInput);
          } else if (error.code === "auth/invalid-email") {
            userFacingMessage = "Invalid email format.";
          }
          displayErrorMessage(userFacingMessage);
        } finally {
          hideLoader();
          submitButton.textContent = "Save Changes";
          submitButton.disabled = false;
        }
      });

      // Authentication State Listener
      auth.onAuthStateChanged((user) => {
        if (user) {
          populateProfileData(user);
        } else {
          window.location.href = "login.html";
        }
      });

      // Logout Logic
      logoutBtn.addEventListener("click", async () => {
        showLoader();
        try {
          await auth.signOut();
        } catch (error) {
          console.error("Error signing out:", error);
          displayErrorMessage("Failed to log out. Please try again.");
        } finally {
          hideLoader();
        }
      });

      // Clear password fields on page load for security
      document.addEventListener("DOMContentLoaded", () => {
        currentPasswordInput.value = "";
        newPasswordInput.value = "";
        confirmNewPasswordInput.value = "";
      });
    </script>
  </body>
</html>